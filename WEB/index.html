<!DOCTYPE html>
<html>
<head>
    <title>Abey</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wdth@90&display=swap" rel="stylesheet">
    <link href='style.css' rel="stylesheet">
	<script src="PapaParse/papaparse.min.js"></script>
    <script type="text/javascript" src="fonctions.js"></script>
    <!-- <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script> -->
</head>

<body>
    <h1 class='centered'>Site des abeilles</h1>
    <div class='okok oui'>
        <p class="centered">Est-ce que ceci est un &lsaquo;<b id="modif">animal</b>&rsaquo;</p>
        <img id="image" src="./images/debut.png" height="200px" width="300px" class="centered">	
        
        <div style="width: 90%; overflow: hidden; margin-bottom: 3em; height: 100px;" class="oui">
            <div style="height: 20px;"></div>
            <div class="flex">
                <div style="width: 44%;"> <!-- purement arbitraire et peut casser à tout moment :) -->
                    <button id="l" class="myButton">&lsaquo;</button>
                </div>
                <div style="width: 7%;">
                    <button id="oui" class="myButton">oui</button>
                </div>
                <div style="width: 44%;">
                    <button id="non" class="myButton">non</button>
                </div>   
                <div style="width: 5%;">
                    <button id="r" class="myButton">&rsaquo;</button>
                </div>
            </div>
       </div>
    </div>

    <div style="height: 20px;"></div>
    <div class="oui">       
        <a href="./about.html"><button class="myButton" id="about" style="float: left;" >A propos de nous</button></a>
        <button class="myButton" id="downconfirm" style="float: right;" >Télécharger fichier corrigé</button>
    </div>
    <div style="height: 15px;"></div>
    <div class="oui">
        <h3 class="centered">Sélectionnez un fichier csv que vous chargerez pour effectuer des vérifications :</h3>
        <div class="flex">
            <label for="uploadfile" class="myButton centered" >
                Choisissez un fichier
            </label>
            <input id="uploadfile" type="file" accept=".csv"/>
        </div>
        <button id="upconfirm" style="visibility: hidden;"></button>
    </div>
</body>
<script type="text/javascript">
    // On renvoie un nombre aléatoire entre une valeur min (incluse)
    // et une valeur max (exclue)
    function getRandomArbitrary(min, max) {
      return Math.floor( Math.random() * (max - min) + min);
  }
  function getRandomInt(max) {
      return Math.floor( Math.random() * max);
  }
  function getKeyByValue(object, value) {
      return Object.keys(object).find(key => object[key] === value);
  }
  
  var label, imActuelle, indice;
  var tab_connaissances=[];
  // var object = new ActiveXObject("Scripting.FileSystemObject"); // ne marche que sur IE :(

  const image = document.getElementById('image').
  addEventListener('load', () => { //calcule le nouvel indice, trouve label et chemin de l'image

      imActuelle=document.getElementById('image').getAttribute("src");
      if (!imActuelle.includes('debut')){
          let i=0;
          while ( imActuelle!=tab_connaissances[i][1] && i < tab_connaissances.length) i++;
          indice=i
          label = tab_connaissances[i][0];
          console.log("Label : ",label);
          console.log("Image : ",imActuelle);
      }
       
  });

  //pour ne pas avoir à passer par un bouton "charger fichier" 
  const loaded = document.getElementById('uploadfile').
  addEventListener('input', () => {
        var confirm = document.getElementById('upconfirm');
        confirm.click();
  });

  const upconfirm = document.getElementById('upconfirm').
  addEventListener('click', () => { //parse le csv pour le transformer en variable exploitable
  Papa.parse(document.getElementById('uploadfile').files[0],
  {
      delimiter: ";",
    //   newline: "\n\r", // trouver un moyen d'enlever les \r qui s'ajoutent à la fin des chemins des photos
      download: false,
      header: false,
      skipEmptyLines: true,
      complete: function(results){
          // console.log(results);  
          for (let i = 1 ; i < results['data'].length; i++) {

              tab_connaissances[i-1]=[...results['data'][i]];
              tab_connaissances[i-1][1]= tab_connaissances[i-1][1].replace('\r','');
              // tab_connaissances.push([results['data'][i][0],results['data'][i][1]]);
          }
          console.log(tab_connaissances);
          document.getElementById('modif').innerHTML=tab_connaissances[0][0];
          document.getElementById('image').src=tab_connaissances[0][1];
      }
  });
});

const downconfirm= document.getElementById('downconfirm').
  addEventListener('click', () => { //parse le csv pour le transformer en variable exploitable
  var csv = Papa.unparse(tab_connaissances,
  {
      download: false,
      header: false,
      newline : "\n",
      delimiter : ';',
      skipEmptyLines: true, 
  });
  if (csv) // pas de dl si le csv n'existe pas
  {
    csv = 'Label;Images\n'.concat(csv); 

    var csvData = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    var csvURL =  null;
    if (navigator.msSaveBlob)
    {
        csvURL = navigator.msSaveBlob(csvData, 'label_new.csv');
    }
    else
    {
        csvURL = window.URL.createObjectURL(csvData);
    }

    var tempLink = document.createElement('a');
    console.log(csvURL);
    tempLink.href = csvURL;
    tempLink.setAttribute('download', 'label_new.csv');
    tempLink.click();
  }
else { console.log("Le csv n'a pas encore été chargé !");}

});

const oui = document.getElementById("oui").
  addEventListener('click', () => {
      var rand,image;
      rand = getRandomInt(tab_connaissances.length);
      image = document.getElementById("image").getAttribute('src');
      console.log(tab_connaissances[rand][1],image);
      while ( tab_connaissances[rand][1] == image) //pour éviter de tomber 2 fois sur la même image
      {
          console.log("meme image");
          rand=getRandomInt(tab_connaissances.length);
      }
      document.getElementById("modif").innerHTML=tab_connaissances[rand][0];
      document.getElementById("image").src=tab_connaissances[rand][1];
  });

  const l = document.getElementById("l"). // bouton <
  addEventListener('click', () => {
      var image;
      
      image = document.getElementById("image").getAttribute('src');
      
      if (indice-1 < 0) indice = tab_connaissances.length-1;
      else indice--;
      document.getElementById("modif").innerHTML=tab_connaissances[indice][0];
      document.getElementById("image").src=tab_connaissances[indice][1];
  });

  const r = document.getElementById("r"). // bouton >
  addEventListener('click', () => {
      var image;
      
      image = document.getElementById("image").getAttribute('src');
      
      if (indice+1 >= tab_connaissances.length) indice = 0;
      else indice++;
      document.getElementById("modif").innerHTML=tab_connaissances[indice][0];
      document.getElementById("image").src=tab_connaissances[indice][1];
  });

  const non = document.getElementById("non").
  addEventListener('click', () => {
      
      console.log(label);
      
      if(label.toString().localeCompare("chien")==0) tab_connaissances[indice][0]="chat"; // que 2 labels donc modif manuelle pour l'instant
      else tab_connaissances[indice][0]="chien";

      console.log(tab_connaissances);
      
//         function moveFile(){
//    var object = new ActiveXObject("Scripting.FileSystemObject");
//    var file = object.GetFile("C:\\wamp\\www\\phptest.php");
//    file.Move("C:\\wamp\\");
//    document.write("File is moved successfully");
// }
      // var myObject;
      // myObject = new ActiveXObject("Scripting.FileSystemObject");
      // myObject.MoveFile("./images/Chat/chat1.jpg", "./images/Chien/chat1.jpg");

      var rand,image;
      rand = getRandomInt(tab_connaissances.length);
      image = document.getElementById("image").getAttribute('src');
      console.log(tab_connaissances[rand][1],image);
      while ( tab_connaissances[rand][1] == image) //pour éviter de tomber 2 fois sur la même image
      {
          console.log("meme image");
          rand=getRandomInt(tab_connaissances.length);
      }
      document.getElementById("modif").innerHTML=tab_connaissances[rand][0];
      document.getElementById("image").src=tab_connaissances[rand][1];
  });
</script>
</html>